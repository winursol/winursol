// burn.js â€” WinurSOL burn helpers (SPL tokens, NFTâ€™ler, boÅŸ hesap kapatma)

import {
  Connection,
  PublicKey,
  SystemProgram,
  Transaction,
  TransactionInstruction,
} from "@solana/web3.js";
import {
  getAssociatedTokenAddress,
  getMint,
  getAccount,
  createTransferInstruction,
  createCloseAccountInstruction,
} from "@solana/spl-token";

/**
 * ğŸ”¥ TÃœM YAKMA HEDEFÄ° (BURN VAULT)
 * Bu adrese transfer edilen token/NFTâ€™ler â€œyakÄ±lmÄ±ÅŸâ€ kabul edilir.
 */
export const BURN_ADDRESS = new PublicKey(
  "GiLefarGmT5zvaeiFiLNmrckRen3MNjrXQ8fHCtAdN3s"
);

/**
 * KÃ¼Ã§Ã¼k yardÄ±mcÄ±: tek transaction gÃ¶nder
 */
export async function sendTx({ connection, wallet, ixs, signers = [] }) {
  const tx = new Transaction().add(...ixs);
  tx.feePayer = wallet.publicKey;
  tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
  const signed = await wallet.signTransaction(tx);
  const sig = await connection.sendRawTransaction(signed.serialize(), {
    skipPreflight: false,
  });
  await connection.confirmTransaction(sig, "confirmed");
  return sig;
}

/**
 * Kaynaktaki SPL token bakiyesini BURN_ADDRESSâ€™in ATAâ€™sÄ±na taÅŸÄ±r
 * ve kaynak token hesabÄ±nÄ± kapatÄ±p kira (rent) SOLâ€™unu kullanÄ±cÄ±ya iade eder.
 *
 * @param {Object} p
 * @param {Connection} p.connection
 * @param {import("@solana/wallet-adapter-react").WalletContextState} p.wallet
 * @param {PublicKey} p.sourceTokenAccount KullanÄ±cÄ±nÄ±n token hesabÄ± (ATA)
 * @param {PublicKey} p.mint Mint adresi
 */
export async function burnSplTokenAccount({ connection, wallet, sourceTokenAccount, mint }) {
  if (!wallet?.publicKey) throw new Error("Wallet baÄŸlÄ± deÄŸil");

  // Kaynak hesabÄ± ve mint bilgileri
  const [acc, mintInfo] = await Promise.all([
    getAccount(connection, sourceTokenAccount),
    getMint(connection, mint),
  ]);

  // Kaynak bakiyesi
  const amount = acc.amount; // BigInt
  if (amount === 0n) {
    // BoÅŸsa sadece kapat
    const ix = createCloseAccountInstruction(
      sourceTokenAccount,
      wallet.publicKey,     // rent iadesi buraya
      wallet.publicKey
    );
    return await sendTx({ connection, wallet, ixs: [ix] });
  }

  // Burn kasasÄ±nÄ±n ATA'sÄ±
  const burnAta = await getAssociatedTokenAddress(mint, BURN_ADDRESS, true);

  // 1) TÃ¼m bakiyeyi burn kasasÄ±na transfer et
  const transferIx = createTransferInstruction(
    sourceTokenAccount,
    burnAta,
    wallet.publicKey,
    amount
  );

  // 2) Kaynak hesabÄ± kapat (rent iadesi)
  const closeIx = createCloseAccountInstruction(
    sourceTokenAccount,
    wallet.publicKey,
    wallet.publicKey
  );

  return await sendTx({ connection, wallet, ixs: [transferIx, closeIx] });
}

/**
 * Tek bir NFT (decimals=0, amount=1) yak
 * NFTâ€™yi BURN_ADDRESSâ€™in ATAâ€™sÄ±na taÅŸÄ±r ve kullanÄ±cÄ±daki token hesabÄ±nÄ± kapatÄ±r.
 *
 * @param {Object} p
 * @param {Connection} p.connection
 * @param {import("@solana/wallet-adapter-react").WalletContextState} p.wallet
 * @param {PublicKey} p.nftMint NFT mint adresi
 * @param {PublicKey} p.ownerNftAta KullanÄ±cÄ±nÄ±n NFT ATAâ€™sÄ±
 */
export async function burnNft({ connection, wallet, nftMint, ownerNftAta }) {
  if (!wallet?.publicKey) throw new Error("Wallet baÄŸlÄ± deÄŸil");

  const mintInfo = await getMint(connection, nftMint);
  if (Number(mintInfo.decimals) !== 0) {
    throw new Error("Bu yardÄ±mcÄ±, decimals=0 (NFT) iÃ§in tasarlandÄ±.");
  }

  const ownerAtaAcc = await getAccount(connection, ownerNftAta);
  if (ownerAtaAcc.amount === 0n) {
    // Zaten boÅŸsa sadece kapat
    const ix = createCloseAccountInstruction(
      ownerNftAta,
      wallet.publicKey,
      wallet.publicKey
    );
    return await sendTx({ connection, wallet, ixs: [ix] });
  }

  const burnAta = await getAssociatedTokenAddress(nftMint, BURN_ADDRESS, true);

  const transferIx = createTransferInstruction(
    ownerNftAta,
    burnAta,
    wallet.publicKey,
    1n
  );

  const closeIx = createCloseAccountInstruction(
    ownerNftAta,
    wallet.publicKey,
    wallet.publicKey
  );

  return await sendTx({ connection, wallet, ixs: [transferIx, closeIx] });
}

/**
 * 0 bakiyeli (empty) token hesaplarÄ±nÄ± kapatarak kira SOLâ€™unu iade eder.
 *
 * @param {Object} p
 * @param {Connection} p.connection
 * @param {import("@solana/wallet-adapter-react").WalletContextState} p.wallet
 * @param {PublicKey[]} p.tokenAccounts KullanÄ±cÄ±ya ait token hesaplarÄ± (ATAâ€™lar)
 */
export async function closeEmptyTokenAccounts({ connection, wallet, tokenAccounts }) {
  if (!wallet?.publicKey) throw new Error("Wallet baÄŸlÄ± deÄŸil");

  const ixs = [];
  for (const ata of tokenAccounts) {
    try {
      const acc = await getAccount(connection, ata);
      if (acc.amount === 0n) {
        ixs.push(
          createCloseAccountInstruction(
            ata,
            wallet.publicKey,
            wallet.publicKey
          )
        );
      }
    } catch (_) {
      // GeÃ§ersiz hesap vs. gÃ¶rmezden gel
    }
  }

  if (!ixs.length) return null;
  return await sendTx({ connection, wallet, ixs });
}
